<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Load Organizer</title>
    <link rel="icon" type="image/png" href="favicon.ico">
    <style>
        body {
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
            margin: 20px;
            background: linear-gradient(135deg, #e0f7fa, #ffffff);
            color: #0f172a;
            transition: background 0.5s ease;
        }

        h1 {
            display: inline;
            font-size: 20px;
            margin-bottom: 8px;
            color: #0ea5a4;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        h1 span {
            cursor: pointer;
        }

        h1 span:hover {
            color: #028090;
        }

        .info-bar {
            font-size: 14px;
            background: #e0f2f1;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .info-bar:hover {
            background: #b2dfdb;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 45px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        textarea,
        .editable-output {
            width: 97%;
            height: 400px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background: #f8f9fa;
            resize: vertical;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
            white-space: pre-wrap;
            transition: box-shadow 0.3s ease, background 0.3s ease;
        }

        textarea:focus,
        .editable-output:focus {
            outline: none;
            box-shadow: 0 0 8px #0ea5a4;
            background: #f1f5f9;
        }

        .controls {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            background: #0ea5a4;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease;
        }

        button:hover {
            transform: scale(1.05);
            background: #028090;
        }

        button.secondary {
            background: #64748b;
        }

        button.secondary:hover {
            background: #475569;
        }

        .output {
            height: auto;
            overflow: visible;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 2px 6px rgba(2, 6, 23, 0.08);
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #f1f5f9;
        }

        .info-input {
            width: 60px;
            padding: 2px 6px;
            font-size: 14px;
            border: 1px solid #94a3b8;
            border-radius: 4px;
        }

        #savedLoads {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .saved-card {
            border-radius: 8px;
            padding: 10px;
            width: 300px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .saved-card pre {
            white-space: pre-wrap;
            /* preserve newlines but allow wrapping */
            word-wrap: break-word;
            /* break long words if needed */
            overflow-wrap: anywhere;
            /* modern way to force break */
            max-width: 100%;
            /* prevent overflow */
        }


        .saved-card:nth-child(4n+1) {
            background: #eef6fb;
        }

        .saved-card:nth-child(4n+2) {
            background: #f5f8e7;
        }

        .saved-card:nth-child(4n+3) {
            background: #f3f8f1;
        }

        .saved-card:nth-child(4n+4) {
            background: #fff4e6;
        }

        #exportBtn {
            background: #0fcfce;
            /* teal (matches theme) */
        }

        #exportBtn:hover {
            background: #028090;
        }

        #importBtn {
            background: #3b82f6;
            /* blue accent */
        }

        #importBtn:hover {
            background: #2563eb;
        }

        .saved-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #e8edf1;
        }

        .saved-actions {
            margin-top: 6px;
            display: flex;
            gap: 8px;
        }

        .success-temp {
            background: #16a34a !important;
        }

        .danger-temp {
            background: #dc2626 !important;
        }
    </style>
</head>

<body>
    <h1>
        <span id="greeting" style="font-size:14px; color:#64748b; margin-right:8px;"></span>
        <span id="hiddenClear">ARehman</span>
    </h1>
    <div class="info-bar">
        <label><input type="checkbox" id="includeDh"> Include Deadhead</label>
        <span id="rpmInfo">RPM: -</span>
        <span id="calc15">@1.5: -</span>
        <span id="calc16">@1.6: -</span>
        <span>Custom <input id="customRpm" class="info-input" type="number" step="0.01" placeholder="1.8"> → <span
                id="customCalc">-</span></span>
        <span>Broker $ <input id="brokerPrice" class="info-input" type="number" step="1" placeholder="1000"> → <span
                id="brokerRpm">-</span></span>
        <span>
            Calc:
            <input id="calcInput" class="info-input" type="text" placeholder="2+2">
            = <span id="calcResult">-</span>
        </span>

    </div>

    <div class="container">
        <div>
            <textarea id="input" placeholder="Paste raw load here..."></textarea>
            <div class="controls">
                <button id="formatBtn">Format</button>
                <button id="clearBtn" class="secondary">Clear</button>
                <button id="copyBtn" class="secondary">Copy Output</button>
            </div>
        </div>
        <div class="output" id="output">
            <div class="card">
                <textarea id="editableOutput" class="editable-output"
                    placeholder="Formatted result will appear here..."></textarea>
            </div>
            <div class="controls">
                <button id="saveBtn">Save Output</button>
                <button id="clearAllBtn" class="secondary">Clear All Saved</button>
            </div>
        </div>
    </div>
    <!-- button for import & export  -->
    <div class="controls">
        <button id="exportBtn">Export Loads</button>
        <input type="file" id="importFile" style="display:none" accept="application/json">
        <button id="importBtn" class="secondary">Import Loads</button>
    </div>
    <div id="savedLoads"></div>

    <script>
        function parseChunk(chunk) {
            let rawLines = chunk.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');

            let rpmLine = rawLines.find(l => /^\$[\d,.]+.*\/mi/i.test(l));
            let rpm = rpmLine ? rpmLine.match(/\$([\d,.]+)/)[1] : '-';
            rawLines = rawLines.filter(l => !/^\$[\d,.]+.*\/mi/i.test(l));

            const out = { price: '', mile: '', dh: '', PU: '', Del: '', puDate: '', weight: '', lengthType: '', brokerName: '', brokerContact: '', rpm: rpm };

            out.price = rawLines[0] || '';
            if (out.price === '-' || out.price === '' || out.price === '–') {
                out.price = '$';
            } else {
                out.price = '$' + out.price.replace(/[^0-9]/g, '');
            }

            out.mile = rawLines[1] || '';
            out.PU = (rawLines[2] && rawLines[4]) ? rawLines[2] + ',' + rawLines[4] : '';
            out.Del = (rawLines[5] && rawLines[7]) ? rawLines[5] + ',' + rawLines[7] : '';
            out.dh = rawLines[8] || '';
            out.puDate = rawLines[9] || '';
            out.weight = rawLines[11] ? 'weight= ' + rawLines[11].replace(/[^0-9]/g, '') + ' lbs' : '';
            out.lengthType = rawLines[12] || '';
            out.brokerName = rawLines[13] || '';
            out.brokerContact = rawLines[14] || '';
            return out;
        }

        function formatOutput(parsed) {
            const lines = [];
            lines.push(parsed.price || '$');
            if (parsed.mile) lines.push('Mile= ' + parsed.mile);
            if (parsed.dh) lines.push('dh' + parsed.dh);
            if (parsed.PU) lines.push(parsed.PU);
            if (parsed.Del) lines.push(parsed.Del);
            if (parsed.puDate) lines.push('Pu= ' + parsed.puDate + '--');
            lines.push('Del= ');
            lines.push('');
            lines.push('COM= ');
            if (parsed.weight) lines.push(parsed.weight);
            if (parsed.lengthType) lines.push(parsed.lengthType);
            lines.push('');
            lines.push((parsed.brokerName || ''));
            lines.push((parsed.brokerContact || ''));
            lines.push('BrokerMC:');
            return lines.join('\n');
        }

        function updateInfoBar(parsed) {
            let mile = parseInt(parsed.mile) || 0;
            let dh = parseInt(parsed.dh.replace(/[^0-9]/g, '')) || 0;
            let includeDh = document.getElementById('includeDh').checked;
            let totalMiles = includeDh ? (mile + dh) : mile;

            document.getElementById('rpmInfo').innerText = 'RPM: ' + (parsed.rpm !== '-' ? '$' + parsed.rpm : '-');
            document.getElementById('calc15').innerText = '@1.5: $' + (totalMiles * 1.5).toFixed(2);
            document.getElementById('calc16').innerText = '@1.6: $' + (totalMiles * 1.6).toFixed(2);

            document.getElementById('customRpm').addEventListener('input', (e) => {
                let val = parseFloat(e.target.value);
                document.getElementById('customCalc').innerText = val ? '$' + (totalMiles * val).toFixed(2) : '-';
            });

            document.getElementById('brokerPrice').addEventListener('input', (e) => {
                let price = parseFloat(e.target.value);
                document.getElementById('brokerRpm').innerText = (price && totalMiles) ? '$' + (price / totalMiles).toFixed(2) : '-';
            });
        }

        function generateFormatted() {
            const txt = document.getElementById('input').value;
            const parsed = parseChunk(txt);
            updateInfoBar(parsed);
            return formatOutput(parsed);
        }

        function updateOutput() {
            const formatted = generateFormatted();
            document.getElementById('editableOutput').value = formatted;
        }

        function tempFeedback(btn, message, type = 'success') {
            const originalText = btn.textContent;

            btn.textContent = message;
            btn.classList.add(type === 'success' ? 'success-temp' : 'danger-temp');

            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('success-temp', 'danger-temp');
            }, 2000);
        }

        function renderSavedLoads() {
            const saved = JSON.parse(localStorage.getItem('savedLoads') || '[]');
            const container = document.getElementById('savedLoads');
            container.innerHTML = '';
            saved.forEach((text, index) => {
                const card = document.createElement('div');
                card.className = 'saved-card';
                card.innerHTML = `<pre>${text}</pre>`;
                const actions = document.createElement('div');
                actions.className = 'saved-actions';
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(text);
                    tempFeedback(copyBtn, 'Copied!', 'success');
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'secondary';
                deleteBtn.onclick = () => {
                    const updated = saved.filter((_, i) => i !== index);
                    localStorage.setItem('savedLoads', JSON.stringify(updated));
                    renderSavedLoads();
                };
                actions.appendChild(copyBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function clearAllFields() {
            document.getElementById('input').value = '';
            document.getElementById('editableOutput').value = '';
            document.getElementById('rpmInfo').innerText = 'RPM: -';
            document.getElementById('calc15').innerText = '@1.5: -';
            document.getElementById('calc16').innerText = '@1.6: -';
            document.getElementById('customCalc').innerText = '-';
            document.getElementById('brokerRpm').innerText = '-';
        }

        document.getElementById('saveBtn').addEventListener('click', (e) => {
            const text = document.getElementById('editableOutput').value.trim();
            if (!text) return;
            const saved = JSON.parse(localStorage.getItem('savedLoads') || '[]');
            saved.unshift(text);
            localStorage.setItem('savedLoads', JSON.stringify(saved));
            renderSavedLoads();
            tempFeedback(e.target, 'Output Saved!', 'success');
        });

        document.getElementById('clearAllBtn').addEventListener('click', (e) => {
            const password = "sahiwalpk"; // set your password here
            const entered = prompt("Enter password to clear all saved loads:");

            if (entered === password) {
                localStorage.removeItem('savedLoads');
                renderSavedLoads();
                tempFeedback(e.target, 'Cleared!', 'danger');
            } else if (entered !== null) {
                tempFeedback(e.target, 'Wrong Password!', 'danger');
            }
        });


        document.getElementById('formatBtn').addEventListener('click', (e) => {
            updateOutput();
            tempFeedback(e.target, 'Formatted!', 'success');
        });

        document.getElementById('clearBtn').addEventListener('click', (e) => {
            clearAllFields();
            tempFeedback(e.target, 'Cleared!', 'danger');
        });

        document.getElementById('copyBtn').addEventListener('click', (e) => {
            let outputText = document.getElementById('editableOutput').value.trim();
            if (!outputText) {
                outputText = generateFormatted();
            }
            navigator.clipboard.writeText(outputText);
            tempFeedback(e.target, 'Copied!', 'success');
        });

        document.getElementById('input').addEventListener('input', updateOutput);
        document.getElementById('includeDh').addEventListener('change', updateOutput);
        document.getElementById('hiddenClear').addEventListener('click', clearAllFields);

        renderSavedLoads();

        // Export saved loads as JSON file
        function exportLoads() {
            const saved = JSON.parse(localStorage.getItem('savedLoads') || '[]');
            if (!saved.length) {
                alert("No saved loads to export.");
                return;
            }
            const blob = new Blob([JSON.stringify(saved, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "savedLoads.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import loads from JSON file (merge, not overwrite)
        function importLoads(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) throw new Error("Invalid file format");

                    const existing = JSON.parse(localStorage.getItem('savedLoads') || '[]');
                    const merged = [...imported, ...existing]; // imported first, then old
                    localStorage.setItem('savedLoads', JSON.stringify(merged));
                    renderSavedLoads();
                    alert("Loads imported successfully!");
                } catch (err) {
                    alert("Error importing loads: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Hook buttons
        document.getElementById("exportBtn").addEventListener("click", exportLoads);
        document.getElementById("importBtn").addEventListener("click", () => {
            document.getElementById("importFile").click();
        });
        document.getElementById("importFile").addEventListener("change", (e) => {
            if (e.target.files.length) {
                importLoads(e.target.files[0]);
            }
        });

        // Greeting based on current time
        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = "Hello";

            if (hour >= 6 && hour < 11) {
                greeting = "Good Morning";
            } else if (hour >= 11 && hour < 17) {
                greeting = "Good Afternoon";
            } else if (hour >= 17 && hour < 21) {
                greeting = "Good Evening";
            } else {
                greeting = "Good Night";
            }

            document.getElementById("greeting").textContent = greeting + ",";
        }

        // Run immediately and update every minute
        setGreeting();
        setInterval(setGreeting, 60000);


        // Live calculator input
        const calcInput = document.getElementById("calcInput");
        const calcResult = document.getElementById("calcResult");

        calcInput.addEventListener("input", (e) => {
            let expr = e.target.value.trim();
            if (!expr) {
                calcResult.textContent = "-";
                return;
            }
            try {
                // Replace "x" or "X" with "*"
                expr = expr.replace(/x/gi, "*");

                // Only allow numbers and safe operators
                if (/^[0-9+\-*/(). ]+$/.test(expr)) {
                    // Safely evaluate
                    let result = eval(expr);
                    calcResult.textContent = isFinite(result) ? result : "Err";
                } else {
                    calcResult.textContent = "Err";
                }
            } catch {
                calcResult.textContent = "Err";
            }
        });

    </script>
</body>

</html>